# GAN-based Synthetic Medical Image Augmentation for increased CNN Performance in COVID-19 Classification

The project has been developed under the supervision of *Prof. Paolo Russo*. The work is required for the fulfilment of credits for the *Vision and Perception course* given by *Prof. Fiora Pirri*, A.Y. 2019-2020.

**AUTHORS**

Akash Garg, New Delhi, September 2020 

Simone Rossetti, Roma, September 2020

**ABSTRACT**

Large-scale annotated datasets have proven to be extremely important part that powers the convolutional neural networks (CNNs) and other deep learning methods. However, it has been observed that obtaining such an enormous dataset is quite challenging in certain domains.

Medical domain is one such area where obtaining an enormous number of images in order to train a classifier is highly challenging and practically inefficient. In this project we try to address the stated critical issue with the help of Generative Adversarial Networks (GANs).  We demonstrate that GAN can be used to generate synthetic medical images when trained with even small number of available real images. Not only this the quality of synthetic images is quite high and thus can be used to augment the original training dataset for further Machine Learning applications. In order to validate the quality of generated images we train a classifier firstly using classical augmentation techniques (rotation, translation, flip and scale) on smaller dataset of available real images. After that another classifier is trained but using real images, images coming from classical augmentation as well as synthetic images generated by the GAN as training dataset. In the latter case we observed an increase in sensitivity and in specificity. Adding to this the total accuracy of classification also increased significantly.

In this project we took inspiration from the work done by Maayan Frid-Adar et. al. in this paper: [*GAN-based Synthetic Medical Image Augmentation for increased CNN Performance in Liver Lesion Classification*](https://arxiv.org/pdf/1803.01229.pdf), and by Mohamed Loey et. al. and in this paper: [*Within the Lack of Chest COVID-19 X-ray Dataset: A Novel Detection Model Based on GAN and Deep Transfer Learning*](https://www.mdpi.com/2073-8994/12/4/651/pdf)

**DATASET**

COVID-19 X-rays chest scans images, 4 classes classification task:

<p align="center" width="100%">
<img src="https://github.com/SimoneRosset/AUGMENTATION_GAN/blob/master/images/classes.png" alt="" width= '800px'/>
</p>

more about dataset source [here](https://github.com/ieee8023/covid-chestxray-dataset).

**RESULTS**:

***GAN***

Below are the stack of real X-ray images coming from the dataset and fake X-ray images generated from GANs trained for each of the four classes,covid, normal, pneumonia bacteria,& pneumonia virus, under consideration.

- Covid X-ray real (left) and fake (right)

<p float="left">
  <img src="/images/covid_o.png" width="45%" height="95%" title="covid real"/>
  <img src="/images/C32.png" width="45%" title="covid fake"/> 
</p>

- Normal X-ray real (left) and fake (right)

<p float="left">
  <img src="/images/normal_o.png" width="45%" height="95%" title="normal real"/>
  <img src="/images/N32.png" width="45%" title="normal fake"/> 
</p>

- Pneumonia bacteria X-ray real (left) and fake (right)

<p float="left">
  <img src="/images/p_bac_o.png" width="45%" height="95%" title="pneumonia bacteria real"/>
  <img src="/images/PB32.png" width="45%" title="pneumonia bacteria fake"/> 
</p>

- Pneumonia virus X-ray real (left) and fake (right)

<p float="left">
  <img src="/images/p_vir_o.png" width="45%" height="95%" title="pneumonia virus real"/>
  <img src="/images/PV32.png" width="45%" title="pneumonia virus fake" /> 
</p>

The above GAN synthetic images were generated by the models trained for 200 epochs present [here](/gan_models/epoch_200/). Models trained for 100 epochs [here](/gan_models/epoch_100/) can be chosen but with a compromise with the quality of synthetic output images 

***CNN Classifier***

We definitely achieved the high quality synthesis of chest X-ray scans using generative adversarial networks (GANs).

We designed a CNN-based solution for pneumonia infection classification task, with comparable results to state-of-the-art methods.

We demonstrated how synthetic augmentation of the CNN training set, using the generated synthetic data by GANs, highly improved classification results: the classification performance using only classic data augmentation yielded 82.7% sensitivity and 90.4% specificity. By adding the synthetic data augmentation the results increased to 90.6% sensitivity and 97.2% specificity.

Total accuracy gain, from 82.7% with classic augmented trainset to 90.7% with synthetic augmented trainset:

<p align="center" width="100%">
<img  src="https://github.com/SimoneRosset/AUGMENTATION_GAN/blob/master/images/tot_acc.png" alt="" width= '600px'/>
</p>

CNN classification performances with classic data augmentation:

<p align="center" width="100%">
<img src="https://github.com/SimoneRosset/AUGMENTATION_GAN/blob/master/images/best_classic.png" alt="" width= '800px'/>
</p>

CNN classification performances with synthetic (DCGAN generated) data augmentation:

<p align="center" width="100%">
<img src="https://github.com/SimoneRosset/AUGMENTATION_GAN/blob/master/images/best_synthetic.png" alt="" width= '800px'/>
</p>

Here the correspondent confusion matrix:

<p align="center" width="100%">
<img src="https://github.com/SimoneRosset/AUGMENTATION_GAN/blob/master/images/best_confusion_synthetic.png" alt="" width= '400px'/>
</p>

Training history (best - 0.907 total accuracy in 720 epochs on trainset made by 270 original images, 2000 classic and 1000 synthetic augmented):

<p align="center" width="100%">
<img src="https://github.com/SimoneRosset/AUGMENTATION_GAN/blob/master/images/best_history.png" alt="" width= '100%'/>
</p>

more about CNN trained models and results achieved [here](/results/).

**DOCUMENTATION**: 

more informations about the work done [here](/report.pdf).
 
# DCAI-augmented-med
- To run the ACGAN: ```python train_acgan.py```
- To run the DCGAN: ```python train_dcgan.py```
- All models and utility functions in `src/`

- To build datasets after training GAN model: ```python build_dataset.py```
- `quantitative_eval.sh` is for measure the quality of images generated.
- Original dataset `custom_covid_dataset/` is downloaded from original repo.


# Pre-trained GANs for Skin-lession Dataset
- Download ckpts for skin-lession trained with 400 epochs here: https://vanderbilt.box.com/s/g4zsdxl3tfxzuwdudnjd1ewk4dh9huvv
- Set the proper paths to load these checkpoint on the `train_acgan_skin_baseline.py`
- Generate new samples from this generative model and conduct the corresponding evaluation